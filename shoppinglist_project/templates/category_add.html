{% extends 'base.html' %}
{% load form_tags %}
{% block content %}
<h2>カテゴリをリストに追加</h2>

<a href="{% url 'app:itemcategory_add' store.store_id %}"
   class="btn btn-secondary mb-3">＋カテゴリを作成</a>

<!-- 🔵 親フォームはこれ１つだけ -->
<form method="post">
  {% csrf_token %}

  <p>追加するカテゴリを選んでください:</p>
  <ul class="list-unstyled">
    {% for cat in form.fields.categories.queryset %}
      <li class="mb-2">
        <div class="category-checkbox d-flex align-items-center gap-2">
          <input type="checkbox" name="categories" value="{{ cat.id }}">
          <span class="category-name">{{ cat.item_category_name }}</span>
          {% with list_pk=category_id_map|dict_get:cat.id %}
            <form id="delete-cat-{{ cat.id }}" method="post"
                  action="{% url 'app:category_master_delete' pk=cat.id %}"
                  style="display:none;">
              {% csrf_token %}
              <input type="hidden" name="store_id" value="{{ store.store_id }}">
            </form>
            <button type="button"
                    class="btn btn-link text-danger p-0"
                    onclick="if (confirm('「{{ cat.item_category_name }}」を本当に削除しますか？')) {
                              document.getElementById('delete-cat-{{ cat.id }}').submit();
                            }">×</button>           
          {% endwith %}
        </div>
      </li>
    {% endfor %}
  </ul>

  <div class="d-flex gap-2 mt-3">
    <button type="submit" class="btn btn-primary">リストに追加する</button>
    <a href="{% url 'app:mylist' store_id=view.kwargs.store_id %}"
      class="link-style cancel-link">キャンセル</a>
  </div>
</form>

{% for cat in form.fields.categories.queryset %}
<form id="delete-cat-{{ cat.id }}"
      method="post"
      action="{% url 'app:category_master_delete' pk=cat.id %}"
      style="display:none;">
  {% csrf_token %}
</form>
{% endfor %}
{% endblock %}
