{% extends "base.html" %}
{% load widget_tweaks %}

{% block content %}
<style>
  /* ① 全体を中央寄せに */
  .pw-reset-wrapper{
    max-width: 25%;          /* ★ページ幅の 1/4 ＝25% */
    min-width: 300px;        /* スマホで細くなりすぎ防止 */
    margin: 0 auto;          /* 中央寄せ */
  }

  /* ② フォーム要素を親幅いっぱいに */
  .pw-reset-wrapper input.form-control,
  .pw-reset-wrapper button{
    width: 100%;
  }

  /* ③ アイコン位置を枠内右寄せで固定 */
  .pw-reset-wrapper .password-wrapper{
    position: relative;
  }
  .pw-reset-wrapper .toggle-eye{
    position: absolute;
    right: 10px; top: 50%;
    transform: translateY(-50%);
    cursor: pointer;
    opacity: .6;
  }
  .pw-reset-wrapper .toggle-eye:hover{opacity:1;}
</style>

{% if validlink %}
<div class="pw-reset-wrapper">
    <h2 class="title">新しいパスワードの設定</h2>
    <p>新しいパスワードを 2 回入力してください。</p>
    <form method="post">
    {% csrf_token %}

    <!-- 1 回目 -->
    <div class="mb-3">
        <label for="id_new_password1" class="form-label">
        パスワード（8文字以上・英数字を含む）
        </label>
        <div class="position-relative">
        {{ form.new_password1|add_class:"form-control pe-5" }}
        <span onclick="togglePw('id_new_password1')" style="position:absolute; right:10px; top:10px; cursor:pointer;">
            <i class="fa-regular fa-eye-slash" id="eye-id_new_password1"></i>
        </span>
        </div>
        {% for error in form.new_password1.errors %}
        <div class="text-danger">{{ error }}</div>
        {% endfor %}
    </div>

    <!-- 2 回目 -->
    <div class="mb-3">
        <label for="id_new_password2" class="form-label">
        パスワード（確認用）
        </label>
        <div class="position-relative">
        {{ form.new_password2|add_class:"form-control pe-5" }}
        <span onclick="togglePw('id_new_password2')" style="position:absolute; right:10px; top:10px; cursor:pointer;">
            <i class="fa-regular fa-eye-slash" id="eye-id_new_password2"></i>
        </span>
        </div>
        {% for error in form.new_password2.errors %}
        <div class="text-danger">{{ error }}</div>
        {% endfor %}
    </div>

    <button type="submit" class="btn btn-primary big-action-btn">変更する</button>
    </form>
</div>

{% else %}
<div class="container mt-5 text-center">
    <h2 class="mb-4">リンクの有効期限が切れています</h2>
    <p class="mb-3">パスワード再設定リンクは 24 時間で失効します。</p>
    <p>お手数ですが、もう一度再設定を行ってください。</p>
    <a href="{% url 'app:password_reset' %}" class="btn btn-primary big-action-btn">
      パスワード再設定メールを再送する
    </a>
</div>
{% endif %}

<script>
function togglePw(id){
  const input = document.getElementById(id);
  const icon  = document.getElementById('eye-'+id);
  if(!input) return;
  if(input.type === 'password'){
      input.type = 'text';
      icon.classList.replace('fa-eye-slash', 'fa-eye');
  }else{
      input.type = 'password';
      icon.classList.replace('fa-eye', 'fa-eye-slash');
  }
}
</script>

{% endblock %}
