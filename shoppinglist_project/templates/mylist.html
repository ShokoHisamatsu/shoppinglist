{% extends 'base.html' %}
{% load static %}
{% load custom_filters %} 
{% block content %}

<h3>{{ shopping_list.list_name }}のショッピングリスト</h3>

<div class="category-wrapper">
  {% for category, items in category_item_map.items %}
    <div class="category-block">

      <!-- ✅ カテゴリ名＋削除ボタン -->
      <div class="category-header">
        <h3>{{ category.item_category_name }}</h3>

        {% with list_category=category_id_map|dict_get:category %}
          {% if list_category.pk %}
            <form method="post"
                  action="{% url 'app:category_link_delete' store_id=store.store_id pk=list_category.pk %}"
                  onsubmit="return confirm('{{ category.item_category_name }}内のアイテムもすべて消えてしまいますがよろしいですか？');"
                  class="d-inline">
              {% csrf_token %}
              <button type="submit" class="btn btn-outline-danger category-delete-btn">削除</button>
            </form>
          {% endif %}
        {% endwith %}
      </div>
      <!-- ✅ アイテム登録フォーム -->
      <form method="POST" action="{% url 'app:mylist' store.store_id %}">
        {% csrf_token %}
        <input class=item-name-input, item-quantity-input, item-memo-input type="hidden" name="category_id" value="{{ category.id }}">
        <div class="item-row">
          <input type="text" name="commodity" maxlength="20" placeholder="商品名(20文字以内)" class="item-name-input" required>
          <input type="number" name="quantity" min="1" value="1" placeholder="個数" class="item-quantity-input">
          <input type="text" name="memo" maxlength="20" placeholder="メモ(20文字以内)" class="item-memo-input">
          <input type="submit" class="btn btn-primary" value="保存">
        </div>

        <div>
          <p id="commodity-alert" class="text-danger mb-0" style="display: none;">※商品名は20文字以内で入力してください</p>
          <p id="memo-alert" class="text-danger mb-0" style="display: none;">※メモは20文字以内で入力してください</p>
        </div>
      </form>

      <!-- ✅ 未チェックのみ表示フィルター -->
      <div class="form-check mb-3">
        <input class="form-check-input check-input filter-unchecked" type="checkbox" id="filter-{{ category.id }}" data-category-id="{{ category.id }}">
        <label class="form-check-label" for="filter-unchecked">
          未購入のみ表示
        </label>
      </div>

      <!-- ✅ 登録済みアイテムの表示 -->
      <div class="item-list-scroll"> 
        {% for item in items %}
          <div class="item-row existing-item" data-category-id="{{ category.id }}">

            <!-- ●チェックボタン（クリックで見た目変更＋保存） -->
            <input type="checkbox" class="check-input" data-id="{{ item.id }}" {% if item.is_checked %}checked{% endif %}>
            <div class="item-info">
              <span class="item-name">{{ item.commodity }}</span>
              <span class="item-quantity">{{ item.quantity }}</span>
              {% if item.memo %}
                <span class="item-memo">{{ item.memo }}</span>
              {% endif %}
            </div>
            

            <!-- ✅ 削除フォーム -->
            <form method="post" action="{% url 'app:item_delete' item.id %}">
              {% csrf_token %}
              <button type="submit" class="btn btn-link text-danger p-0" onclick="return confirm('この商品を削除しますか？');">
                ×
              </button>
            </form>
          </div>
        {% empty %}
          <p>商品がが登録されていません。必要な項目を入力して追加してください。</p>
        {% endfor %}
      </div>
    </div>
  {% endfor %}
</div>

<!-- ✅ カテゴリがないときだけ表示 -->
{% if not category_item_map %}
  <p class="text-danger fw-bold mt-4">
     まずは「＋カテゴリ追加」ボタンからカテゴリを登録してみましょう！<br>
    「カテゴリ」は「野菜・果物」「肉・魚」など、ショッピングリストを整理するために分類します。
  </p>
{% endif %}

<!-- ✅ 新規追加ボタン -->
<a href="{% url 'app:category_add' store.store_id %}" class="btn btn-secondary mt-3">＋カテゴリ追加</a>


<style>
    .mylist-container {
      max-width: 600px;
      margin: 0 auto;
      padding: 24px;
    }
  
    .category-wrapper {
      display: flex;
      gap: 20px;           /* ← 余白は gap だけに統一  */
      overflow-x: auto;    /* ← はみ出したときだけ横スクロール */
      overflow-y: hidden;
      padding-bottom: 6px; /* ← スクロールバーぶんの逃げ */
      box-sizing: border-box;
    }
  
    .category-block {
      width: 420px;
      flex: 0 0 420px;
      background-color: #fff;
      border: 1px solid #ccc;
      border-radius: 12px;
      padding: 12px;
      box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
      box-sizing: border-box;
      display: flex;
      flex-shrink: 0;
    }
  
    .category-block h3 {
      margin-bottom: 8px;
      font-weight: bold;
      font-size: 1.1em;
    }

    .item-list-scroll {
      flex: 1 1 auto;   /* 余った高さをすべて使用 */
      min-height: 0;    /* ← これがないと flex 子が縮まらない */
      overflow-y: auto;
      overflow-x: hidden;
      margin-top: 6px;
      border-top: 1px solid #eee;
      padding-top: 6px;
    }
  
    .item-row {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap:10px;
      margin-bottom: 4px;
      padding-right: 0;  
    }

    
    .item-row input[type="text"],
    .item-row input[type="number"] {
      padding: 4px;
      font-size: 0.9em;
      border: 1px solid #ccc;
      border-radius: 6px;
    }

    .item-row input[name="commodity"] {
      width: 50%;
    }
    .item-row input[name="quantity"] {
      width: 40px;
      text-align: center;
    }
    .item-row input[name="memo"] {
      width: 50%;
    }
    
    .item-info {
      display: grid;
      grid-template-columns: 10em 2em 10em;  /* 商品名・数量・メモの順 */
      gap: 8px;
      align-items: center;
    }
  
    .item-name {
      justify-self: start;
      font-size: 16px;
      word-break: break-word;
      white-space: normal;
      text-align: left;
    }
    
    .item-quantity {
      width: 2em;
      flex-shrink: 0;
      text-align: center;
    }
    
    .item-memo {
      font-size: 16px;
      color: #666;
      word-break: break-word;
      display: inline-block;
      max-width: 10em;  /* ←10文字分幅 */
      white-space: normal;
      text-align: left;
      justify-self: start;
    }
  
    .delete-btn {
      margin-left: auto; 
      background: none;
      border: none;
      color: #999;
      font-size: 1.2em;
      cursor: pointer;
    }

    .add-category-link {
      display: inline-block;
      padding: 6px 12px;
      background-color: #eee;
      border: 1px solid #ccc;
      border-radius: 6px;
      text-decoration: none;
      color: #333;
    }
    .add-category-link:hover {
      background-color: #ddd;
    }

    .delete-category-link {
      display: inline-block;
      font-size: 0.9em;
      color: #888;
      text-decoration: underline;
      margin-bottom: 6px;
      cursor: pointer;
    }

    .category-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
</style>

<!-- ✅ アイテム追加フォーム制御スクリプト -->
<script>
  document.addEventListener('DOMContentLoaded', function () {

    document.querySelectorAll('.add-item-button').forEach(button => {
      button.addEventListener('click', () => {
        const categoryId = button.dataset.categoryId;
        const target = document.getElementById('new-item-form-' + categoryId);
  
        if (target.querySelector('form')) return;
  
        target.innerHTML = `
          <form method="POST" action="${window.location.pathname}">
            {% csrf_token %}
            <input type="hidden" name="category_id" value="${categoryId}">
            <input type="text" name="name" placeholder="商品名" required>
            <input type="number" name="quantity" placeholder="個数">
            <input type="text" name="memo" placeholder="メモ">
            <button type="submit" class="btn-primary">保存</button>
          </form>
        `;
      });
    });
  });
</script>

<script>
  document.addEventListener('DOMContentLoaded', function () {
    const commodityInput = document.querySelector('.item-name-input');
    const commodityAlert = document.getElementById('commodity-alert');

    const memoInput = document.querySelector('.item-memo-input');
    const memoAlert = document.getElementById('memo-alert');

    if (commodityInput) {
      commodityInput.addEventListener('input', () => {
        commodityAlert.style.display = commodityInput.value.length > 20 ? 'inline' : 'none';
      });
    }

    if (memoInput) {
      memoInput.addEventListener('input', () => {
        memoAlert.style.display = memoInput.value.length > 20 ? 'inline' : 'none';
      });
    }
  });
</script>

<script>
// ✅ CSRFトークンを取得する関数（Django公式）
function getCookie(name) {
  let cookieValue = null;
  if (document.cookie && document.cookie !== '') {
    const cookies = document.cookie.split(';');
    for (let i = 0; i < cookies.length; i++) {
      const cookie = cookies[i].trim();
      // cookieの名前と一致するか確認
      if (cookie.substring(0, name.length + 1) === (name + '=')) {
        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
        break;
      }
    }
  }
  return cookieValue;
}

// ✅ 全チェックボックスにイベントを付与
document.querySelectorAll('.check-input').forEach(input => {
  input.addEventListener('change', function () {
    const isChecked = this.checked;
    const itemId = this.dataset.id;

    fetch('/shopli/toggle_item_check/', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'X-CSRFToken': getCookie('csrftoken')
      },
      body: JSON.stringify({
        item_id: itemId,
        is_checked: isChecked
      })
    })
    .then(response => response.json())
    .then(data => {
      if (data.status !== 'ok') {
        console.error('保存失敗:', data.message);
      }
    })
    .catch(error => {
      console.error('通信エラー:', error);
    });
  });
});
</script>


<script>
document.addEventListener("DOMContentLoaded", function () {
  const filters = document.querySelectorAll(".filter-unchecked");

  filters.forEach(function (filter) {
    const categoryId = filter.dataset.categoryId;
    const savedState = localStorage.getItem("filter-" + categoryId);

    if (savedState === "on") {
      filter.checked = true;
      toggleItems(categoryId, true);  // ← 初回ロード時にも反映
    }

    filter.addEventListener("change", function () {
      const isChecked = filter.checked;
      localStorage.setItem("filter-" + categoryId, isChecked ? "on" : "off");
      toggleItems(categoryId, isChecked);
    });
  });

  function toggleItems(categoryId, showOnlyUnchecked) {
    const items = document.querySelectorAll(`.item-row.existing-item[data-category-id="${categoryId}"]`);

    items.forEach(function (item) {
      const checkbox = item.querySelector('input[type="checkbox"]');
      if (showOnlyUnchecked && checkbox.checked) {
        item.style.display = "none";
      } else {
        item.style.display = "";
      }
    });
  }
});
</script>

{% endblock %}